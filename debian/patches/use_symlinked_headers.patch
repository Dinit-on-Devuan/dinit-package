From 80323d1dfd695ac2cc5ddef09e0f9852330cbe40 Mon Sep 17 00:00:00 2001
From: Davin McCall <davmac@davmac.org>
Date: Sat, 10 Dec 2022 08:05:00 +1000
Subject: [PATCH] Use symlinks for headers in tests, rather than copying

Changes initially done by mobin-2008.
---
 .gitignore                                      |  2 --
 src/tests/Makefile                              |  9 +--------
 src/tests/cptests/Makefile                      | 12 ++----------
 src/tests/cptests/includes/baseproc-sys.h       |  1 +
 src/tests/cptests/includes/control-cmds.h       |  1 +
 src/tests/cptests/includes/control.h            |  1 +
 src/tests/cptests/includes/cpbuffer.h           |  1 +
 src/tests/cptests/includes/dinit-client.h       |  1 +
 src/tests/cptests/includes/dinit-env.h          |  1 +
 src/tests/cptests/includes/dinit-ll.h           |  1 +
 src/tests/cptests/includes/dinit-log.h          |  1 +
 src/tests/cptests/includes/dinit-socket.h       |  1 +
 src/tests/cptests/includes/dinit-util.h         |  1 +
 src/tests/cptests/includes/dinit-utmp.h         |  1 +
 src/tests/cptests/includes/dinit.h              |  1 +
 src/tests/cptests/includes/load-service.h       |  1 +
 src/tests/cptests/includes/options-processing.h |  1 +
 src/tests/cptests/includes/proc-service.h       |  1 +
 src/tests/cptests/includes/service-constants.h  |  1 +
 src/tests/cptests/includes/service-dir.h        |  1 +
 src/tests/cptests/includes/service-listener.h   |  1 +
 src/tests/cptests/includes/service.h            |  1 +
 src/tests/cptests/includes/static-string.h      |  1 +
 src/tests/includes/baseproc-sys.h               |  1 +
 src/tests/includes/control-cmds.h               |  1 +
 src/tests/includes/control.h                    |  1 +
 src/tests/includes/cpbuffer.h                   |  1 +
 src/tests/includes/dinit-client.h               |  1 +
 src/tests/includes/dinit-env.h                  |  1 +
 src/tests/includes/dinit-ll.h                   |  1 +
 src/tests/includes/dinit-log.h                  |  1 +
 src/tests/includes/dinit-socket.h               |  1 +
 src/tests/includes/dinit-util.h                 |  1 +
 src/tests/includes/dinit-utmp.h                 |  1 +
 src/tests/includes/dinit.h                      |  1 +
 src/tests/includes/load-service.h               |  1 +
 src/tests/includes/options-processing.h         |  1 +
 src/tests/includes/proc-service.h               |  1 +
 src/tests/includes/service-constants.h          |  1 +
 src/tests/includes/service-dir.h                |  1 +
 src/tests/includes/service-listener.h           |  1 +
 src/tests/includes/service.h                    |  1 +
 src/tests/includes/static-string.h              |  1 +
 43 files changed, 43 insertions(+), 20 deletions(-)
 create mode 120000 src/tests/cptests/includes/baseproc-sys.h
 create mode 120000 src/tests/cptests/includes/control-cmds.h
 create mode 120000 src/tests/cptests/includes/control.h
 create mode 120000 src/tests/cptests/includes/cpbuffer.h
 create mode 120000 src/tests/cptests/includes/dinit-client.h
 create mode 120000 src/tests/cptests/includes/dinit-env.h
 create mode 120000 src/tests/cptests/includes/dinit-ll.h
 create mode 120000 src/tests/cptests/includes/dinit-log.h
 create mode 120000 src/tests/cptests/includes/dinit-socket.h
 create mode 120000 src/tests/cptests/includes/dinit-util.h
 create mode 120000 src/tests/cptests/includes/dinit-utmp.h
 create mode 120000 src/tests/cptests/includes/dinit.h
 create mode 120000 src/tests/cptests/includes/load-service.h
 create mode 120000 src/tests/cptests/includes/options-processing.h
 create mode 120000 src/tests/cptests/includes/proc-service.h
 create mode 120000 src/tests/cptests/includes/service-constants.h
 create mode 120000 src/tests/cptests/includes/service-dir.h
 create mode 120000 src/tests/cptests/includes/service-listener.h
 create mode 120000 src/tests/cptests/includes/service.h
 create mode 120000 src/tests/cptests/includes/static-string.h
 create mode 120000 src/tests/includes/baseproc-sys.h
 create mode 120000 src/tests/includes/control-cmds.h
 create mode 120000 src/tests/includes/control.h
 create mode 120000 src/tests/includes/cpbuffer.h
 create mode 120000 src/tests/includes/dinit-client.h
 create mode 120000 src/tests/includes/dinit-env.h
 create mode 120000 src/tests/includes/dinit-ll.h
 create mode 120000 src/tests/includes/dinit-log.h
 create mode 120000 src/tests/includes/dinit-socket.h
 create mode 120000 src/tests/includes/dinit-util.h
 create mode 120000 src/tests/includes/dinit-utmp.h
 create mode 120000 src/tests/includes/dinit.h
 create mode 120000 src/tests/includes/load-service.h
 create mode 120000 src/tests/includes/options-processing.h
 create mode 120000 src/tests/includes/proc-service.h
 create mode 120000 src/tests/includes/service-constants.h
 create mode 120000 src/tests/includes/service-dir.h
 create mode 120000 src/tests/includes/service-listener.h
 create mode 120000 src/tests/includes/service.h
 create mode 120000 src/tests/includes/static-string.h

diff --git a/.gitignore b/.gitignore
index 54342ee0..41a291c2 100644
--- a/.gitignore
+++ b/.gitignore
@@ -10,8 +10,6 @@
 /src/tests/proctests
 /src/tests/loadtests
 /src/tests/envtests
-/src/tests/includes
-/src/tests/cptests/includes
 /src/tests/cptests/cptests
 /src/tests/cptests/corpus
 /src/tests/cptests/fuzz
diff --git a/src/tests/Makefile b/src/tests/Makefile
index 1f0c9852..fe0a0a50 100644
--- a/src/tests/Makefile
+++ b/src/tests/Makefile
@@ -5,7 +5,7 @@ parent_objs = service.o proc-service.o dinit-log.o load-service.o baseproc-servi
 
 check: build-tests run-tests
 
-build-tests: prepare-incdir tests proctests loadtests envtests
+build-tests: tests proctests loadtests envtests
 	$(MAKE) -C cptests build-tests
 
 run-tests: tests proctests loadtests envtests
@@ -15,13 +15,6 @@ run-tests: tests proctests loadtests envtests
 	./envtests
 	$(MAKE) -C cptests run-tests
 
-# Create an "includes" directory populated with a combination of real and mock headers:
-prepare-incdir:
-	mkdir -p includes
-	rm -rf includes/*.h
-	cd includes; ln -f ../../includes/*.h .
-	cd includes; ln -f ../test-includes/*.h .
-
 tests: $(parent_objs) tests.o test-dinit.o test-bpsys.o test-run-child-proc.o
 	$(CXX) $(SANITIZEOPTS) -o tests $(parent_objs) tests.o test-dinit.o test-bpsys.o test-run-child-proc.o $(CXXOPTS) $(LDFLAGS)
 
diff --git a/src/tests/cptests/Makefile b/src/tests/cptests/Makefile
index cdf5096a..19c73e4c 100644
--- a/src/tests/cptests/Makefile
+++ b/src/tests/cptests/Makefile
@@ -6,18 +6,10 @@ parent_objs = control.o dinit-log.o service.o load-service.o proc-service.o base
 
 check: build-tests run-tests
 
-build-tests: prepare-incdir cptests
+build-tests: cptests
 
 run-tests: cptests
 	./cptests
-	
-# Create an "includes" directory populated with a combination of real and mock headers:
-prepare-incdir:
-	mkdir -p includes
-	rm -rf includes/*.h
-	cd includes; ln -f ../../../includes/*.h .
-	cd includes; ln -f ../../test-includes/dinit.h .
-	cd includes; ln -f ../../test-includes/baseproc-sys.h .
 
 cptests: cptests.o $(parent_objs) $(parent_test_objs)
 	$(CXX) $(SANITIZEOPTS) -o cptests cptests.o $(parent_test_objects) $(parent_objs) $(CXXOPTS) $(LDFLAGS)
@@ -45,7 +37,7 @@ fuzz_objects = $(foreach obj,$(parent_objs),fuzz-$(obj))
 ../../../build/includes/mconfig.h: ../../../mconfig
 	$(MAKE) -C ../../../build all
 
-fuzz: prepare-incdir ../../../build/includes/mconfig.h fuzz.cc $(fuzz_parent_test_objects) $(fuzz_objects)
+fuzz: ../../../build/includes/mconfig.h fuzz.cc $(fuzz_parent_test_objects) $(fuzz_objects)
 	clang++ -std=c++11 -g -O1 -Iincludes -I../../../dasynq/include -I../../../build/includes/ -fsanitize=fuzzer,address,undefined,leak fuzz.cc $(fuzz_parent_test_objects) $(fuzz_objects) -o fuzz
 
 $(fuzz_parent_test_objects): fuzz-%.o: ../%.cc
diff --git a/src/tests/cptests/includes/baseproc-sys.h b/src/tests/cptests/includes/baseproc-sys.h
new file mode 120000
index 00000000..ad53c2ee
--- /dev/null
+++ b/src/tests/cptests/includes/baseproc-sys.h
@@ -0,0 +1 @@
+../../test-includes/baseproc-sys.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/control-cmds.h b/src/tests/cptests/includes/control-cmds.h
new file mode 120000
index 00000000..22f553af
--- /dev/null
+++ b/src/tests/cptests/includes/control-cmds.h
@@ -0,0 +1 @@
+../../../includes/control-cmds.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/control.h b/src/tests/cptests/includes/control.h
new file mode 120000
index 00000000..52a4ae54
--- /dev/null
+++ b/src/tests/cptests/includes/control.h
@@ -0,0 +1 @@
+../../../includes/control.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/cpbuffer.h b/src/tests/cptests/includes/cpbuffer.h
new file mode 120000
index 00000000..59a971e2
--- /dev/null
+++ b/src/tests/cptests/includes/cpbuffer.h
@@ -0,0 +1 @@
+../../../includes/cpbuffer.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/dinit-client.h b/src/tests/cptests/includes/dinit-client.h
new file mode 120000
index 00000000..efe2bcbf
--- /dev/null
+++ b/src/tests/cptests/includes/dinit-client.h
@@ -0,0 +1 @@
+../../../includes/dinit-client.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/dinit-env.h b/src/tests/cptests/includes/dinit-env.h
new file mode 120000
index 00000000..84172780
--- /dev/null
+++ b/src/tests/cptests/includes/dinit-env.h
@@ -0,0 +1 @@
+../../../includes/dinit-env.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/dinit-ll.h b/src/tests/cptests/includes/dinit-ll.h
new file mode 120000
index 00000000..053d196b
--- /dev/null
+++ b/src/tests/cptests/includes/dinit-ll.h
@@ -0,0 +1 @@
+../../../includes/dinit-ll.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/dinit-log.h b/src/tests/cptests/includes/dinit-log.h
new file mode 120000
index 00000000..921ab242
--- /dev/null
+++ b/src/tests/cptests/includes/dinit-log.h
@@ -0,0 +1 @@
+../../../includes/dinit-log.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/dinit-socket.h b/src/tests/cptests/includes/dinit-socket.h
new file mode 120000
index 00000000..21501035
--- /dev/null
+++ b/src/tests/cptests/includes/dinit-socket.h
@@ -0,0 +1 @@
+../../../includes/dinit-socket.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/dinit-util.h b/src/tests/cptests/includes/dinit-util.h
new file mode 120000
index 00000000..0752f464
--- /dev/null
+++ b/src/tests/cptests/includes/dinit-util.h
@@ -0,0 +1 @@
+../../../includes/dinit-util.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/dinit-utmp.h b/src/tests/cptests/includes/dinit-utmp.h
new file mode 120000
index 00000000..5b96825b
--- /dev/null
+++ b/src/tests/cptests/includes/dinit-utmp.h
@@ -0,0 +1 @@
+../../../includes/dinit-utmp.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/dinit.h b/src/tests/cptests/includes/dinit.h
new file mode 120000
index 00000000..fee4a977
--- /dev/null
+++ b/src/tests/cptests/includes/dinit.h
@@ -0,0 +1 @@
+../../test-includes/dinit.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/load-service.h b/src/tests/cptests/includes/load-service.h
new file mode 120000
index 00000000..3388a2a1
--- /dev/null
+++ b/src/tests/cptests/includes/load-service.h
@@ -0,0 +1 @@
+../../../includes/load-service.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/options-processing.h b/src/tests/cptests/includes/options-processing.h
new file mode 120000
index 00000000..e0461f6f
--- /dev/null
+++ b/src/tests/cptests/includes/options-processing.h
@@ -0,0 +1 @@
+../../../includes/options-processing.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/proc-service.h b/src/tests/cptests/includes/proc-service.h
new file mode 120000
index 00000000..2d1bcbc5
--- /dev/null
+++ b/src/tests/cptests/includes/proc-service.h
@@ -0,0 +1 @@
+../../../includes/proc-service.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/service-constants.h b/src/tests/cptests/includes/service-constants.h
new file mode 120000
index 00000000..f074d1f5
--- /dev/null
+++ b/src/tests/cptests/includes/service-constants.h
@@ -0,0 +1 @@
+../../../includes/service-constants.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/service-dir.h b/src/tests/cptests/includes/service-dir.h
new file mode 120000
index 00000000..0f830ec9
--- /dev/null
+++ b/src/tests/cptests/includes/service-dir.h
@@ -0,0 +1 @@
+../../../includes/service-dir.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/service-listener.h b/src/tests/cptests/includes/service-listener.h
new file mode 120000
index 00000000..3f607556
--- /dev/null
+++ b/src/tests/cptests/includes/service-listener.h
@@ -0,0 +1 @@
+../../../includes/service-listener.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/service.h b/src/tests/cptests/includes/service.h
new file mode 120000
index 00000000..add28d9c
--- /dev/null
+++ b/src/tests/cptests/includes/service.h
@@ -0,0 +1 @@
+../../../includes/service.h
\ No newline at end of file
diff --git a/src/tests/cptests/includes/static-string.h b/src/tests/cptests/includes/static-string.h
new file mode 120000
index 00000000..9188764d
--- /dev/null
+++ b/src/tests/cptests/includes/static-string.h
@@ -0,0 +1 @@
+../../../includes/static-string.h
\ No newline at end of file
diff --git a/src/tests/includes/baseproc-sys.h b/src/tests/includes/baseproc-sys.h
new file mode 120000
index 00000000..67d3b95d
--- /dev/null
+++ b/src/tests/includes/baseproc-sys.h
@@ -0,0 +1 @@
+../test-includes/baseproc-sys.h
\ No newline at end of file
diff --git a/src/tests/includes/control-cmds.h b/src/tests/includes/control-cmds.h
new file mode 120000
index 00000000..74112736
--- /dev/null
+++ b/src/tests/includes/control-cmds.h
@@ -0,0 +1 @@
+../../includes/control-cmds.h
\ No newline at end of file
diff --git a/src/tests/includes/control.h b/src/tests/includes/control.h
new file mode 120000
index 00000000..2f75a4a0
--- /dev/null
+++ b/src/tests/includes/control.h
@@ -0,0 +1 @@
+../test-includes/control.h
\ No newline at end of file
diff --git a/src/tests/includes/cpbuffer.h b/src/tests/includes/cpbuffer.h
new file mode 120000
index 00000000..fcb804ed
--- /dev/null
+++ b/src/tests/includes/cpbuffer.h
@@ -0,0 +1 @@
+../../includes/cpbuffer.h
\ No newline at end of file
diff --git a/src/tests/includes/dinit-client.h b/src/tests/includes/dinit-client.h
new file mode 120000
index 00000000..bf03433e
--- /dev/null
+++ b/src/tests/includes/dinit-client.h
@@ -0,0 +1 @@
+../../includes/dinit-client.h
\ No newline at end of file
diff --git a/src/tests/includes/dinit-env.h b/src/tests/includes/dinit-env.h
new file mode 120000
index 00000000..ca515e42
--- /dev/null
+++ b/src/tests/includes/dinit-env.h
@@ -0,0 +1 @@
+../../includes/dinit-env.h
\ No newline at end of file
diff --git a/src/tests/includes/dinit-ll.h b/src/tests/includes/dinit-ll.h
new file mode 120000
index 00000000..766a6074
--- /dev/null
+++ b/src/tests/includes/dinit-ll.h
@@ -0,0 +1 @@
+../../includes/dinit-ll.h
\ No newline at end of file
diff --git a/src/tests/includes/dinit-log.h b/src/tests/includes/dinit-log.h
new file mode 120000
index 00000000..66d6b2d7
--- /dev/null
+++ b/src/tests/includes/dinit-log.h
@@ -0,0 +1 @@
+../../includes/dinit-log.h
\ No newline at end of file
diff --git a/src/tests/includes/dinit-socket.h b/src/tests/includes/dinit-socket.h
new file mode 120000
index 00000000..db873825
--- /dev/null
+++ b/src/tests/includes/dinit-socket.h
@@ -0,0 +1 @@
+../../includes/dinit-socket.h
\ No newline at end of file
diff --git a/src/tests/includes/dinit-util.h b/src/tests/includes/dinit-util.h
new file mode 120000
index 00000000..ad5e740e
--- /dev/null
+++ b/src/tests/includes/dinit-util.h
@@ -0,0 +1 @@
+../../includes/dinit-util.h
\ No newline at end of file
diff --git a/src/tests/includes/dinit-utmp.h b/src/tests/includes/dinit-utmp.h
new file mode 120000
index 00000000..88c353ce
--- /dev/null
+++ b/src/tests/includes/dinit-utmp.h
@@ -0,0 +1 @@
+../../includes/dinit-utmp.h
\ No newline at end of file
diff --git a/src/tests/includes/dinit.h b/src/tests/includes/dinit.h
new file mode 120000
index 00000000..1c5925ec
--- /dev/null
+++ b/src/tests/includes/dinit.h
@@ -0,0 +1 @@
+../test-includes/dinit.h
\ No newline at end of file
diff --git a/src/tests/includes/load-service.h b/src/tests/includes/load-service.h
new file mode 120000
index 00000000..3e2d7923
--- /dev/null
+++ b/src/tests/includes/load-service.h
@@ -0,0 +1 @@
+../../includes/load-service.h
\ No newline at end of file
diff --git a/src/tests/includes/options-processing.h b/src/tests/includes/options-processing.h
new file mode 120000
index 00000000..7dcf1bde
--- /dev/null
+++ b/src/tests/includes/options-processing.h
@@ -0,0 +1 @@
+../../includes/options-processing.h
\ No newline at end of file
diff --git a/src/tests/includes/proc-service.h b/src/tests/includes/proc-service.h
new file mode 120000
index 00000000..470938cf
--- /dev/null
+++ b/src/tests/includes/proc-service.h
@@ -0,0 +1 @@
+../../includes/proc-service.h
\ No newline at end of file
diff --git a/src/tests/includes/service-constants.h b/src/tests/includes/service-constants.h
new file mode 120000
index 00000000..d84093fc
--- /dev/null
+++ b/src/tests/includes/service-constants.h
@@ -0,0 +1 @@
+../../includes/service-constants.h
\ No newline at end of file
diff --git a/src/tests/includes/service-dir.h b/src/tests/includes/service-dir.h
new file mode 120000
index 00000000..4e5b7b38
--- /dev/null
+++ b/src/tests/includes/service-dir.h
@@ -0,0 +1 @@
+../../includes/service-dir.h
\ No newline at end of file
diff --git a/src/tests/includes/service-listener.h b/src/tests/includes/service-listener.h
new file mode 120000
index 00000000..525a9291
--- /dev/null
+++ b/src/tests/includes/service-listener.h
@@ -0,0 +1 @@
+../../includes/service-listener.h
\ No newline at end of file
diff --git a/src/tests/includes/service.h b/src/tests/includes/service.h
new file mode 120000
index 00000000..7cf7d7e4
--- /dev/null
+++ b/src/tests/includes/service.h
@@ -0,0 +1 @@
+../../includes/service.h
\ No newline at end of file
diff --git a/src/tests/includes/static-string.h b/src/tests/includes/static-string.h
new file mode 120000
index 00000000..a5c96ebb
--- /dev/null
+++ b/src/tests/includes/static-string.h
@@ -0,0 +1 @@
+../../includes/static-string.h
\ No newline at end of file
