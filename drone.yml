kind: pipeline
name: dinit-package

steps:
- name: build_amd64_chimaera
  image: dyne/devuan:chimaera
  pull: always
  commands:
  - su root
  - apt update
  - apt install gpg -y
  - wget -qO - 'https://proget.makedeb.org/debian-feeds/makedeb.pub' | gpg --dearmor | tee /usr/share/keyrings/makedeb-archive-keyring.gpg 1> /dev/null
  - echo 'deb [signed-by=/usr/share/keyrings/makedeb-archive-keyring.gpg arch=all] https://proget.makedeb.org/ makedeb main' | tee /etc/apt/sources.list.d/makedeb.list
  - apt update
  - apt install makedeb -y
  - apt install sudo -y
  - useradd builduser -m
  - passwd -d builduser
  - printf 'builduser ALL=(ALL) ALL\n' | tee -a /etc/sudoers # passwordless sudo
  - chown -R builduser:builduser ./
  - mkdir build_chimaera
  - cd build_chimaera
  - sudo -u builduser makedeb -si --no-confirm
  - ls -lah *.deb
  - cd ..
  - exit 0

- name: build_amd64_beowulf
  image: dyne/devuan:beowulf
  pull: always
  commands:
  - su root
  - apt update
  - apt upgrade -y
  - apt install gpg -y
  - wget -qO - 'https://proget.makedeb.org/debian-feeds/makedeb.pub' | gpg --dearmor | tee /usr/share/keyrings/makedeb-archive-keyring.gpg 1> /dev/null
  - echo 'deb [signed-by=/usr/share/keyrings/makedeb-archive-keyring.gpg arch=all] https://proget.makedeb.org/ makedeb main' | tee /etc/apt/sources.list.d/makedeb.list
  - apt update
  - apt install makedeb -y
  - apt install sudo -y
  - useradd builduser -m
  - passwd -d builduser
  - printf 'builduser ALL=(ALL) ALL\n' | tee -a /etc/sudoers # passwordless sudo
  - chown -R builduser:builduser ./

  # Fix [E: Invalid operation satisfy] on beowulf
  # Devuan beowulf does not support [apt satisfy]. We need install makedepends manualy
  - apt install g++ make m4 -y

  - mkdir build_beowulf
  - cd build_beowulf
  - sudo -u builduser makedeb -si --no-confirm
  - ls -lah *.deb
  - cd ..
  - exit 0

- name: build_amd64_ceres
  image: dyne/devuan:ceres
  pull: always
  commands:
  - su root
  - apt update
  - apt upgrade -y # We need upgrade system packages on devuan ceres for building
  - apt autopurge -y # We need purge old packages on devuan ceres for building
  - apt install gpg -y
  - wget -qO - 'https://proget.makedeb.org/debian-feeds/makedeb.pub' | gpg --dearmor | tee /usr/share/keyrings/makedeb-archive-keyring.gpg 1> /dev/null
  - echo 'deb [signed-by=/usr/share/keyrings/makedeb-archive-keyring.gpg arch=all] https://proget.makedeb.org/ makedeb main' | tee /etc/apt/sources.list.d/makedeb.list
  - apt update
  - apt install makedeb -y
  - apt install sudo -y
  - useradd builduser -m
  - passwd -d builduser
  - printf 'builduser ALL=(ALL) ALL\n' | tee -a /etc/sudoers # passwordless sudo
  - chown -R builduser:builduser ./
  - apt install g++ make m4 build-essential -y
  - mkdir build_ceres
  - cd build_ceres
  - sudo -u builduser makedeb -si --no-confirm
  - ls -lah *.deb
  - cd ..
  - exit 0
