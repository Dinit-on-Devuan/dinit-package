kind: pipeline
name: dinit-package

steps:
- name: build_amd64_chimaera
  image: dyne/devuan:chimaera
  pull: always
  volumes:
  - /tmp/packages:/debs
  commands:
  - su root
  - apt update
  - apt install gpg -y
  - wget -qO - 'https://proget.makedeb.org/debian-feeds/makedeb.pub' | gpg --dearmor | tee /usr/share/keyrings/makedeb-archive-keyring.gpg 1> /dev/null
  - echo 'deb [signed-by=/usr/share/keyrings/makedeb-archive-keyring.gpg arch=all] https://proget.makedeb.org/ makedeb main' | tee /etc/apt/sources.list.d/makedeb.list
  - apt update
  - apt install makedeb -y
  - apt install sudo -y
  - useradd builduser -m
  - passwd -d builduser
  - printf 'builduser ALL=(ALL) ALL\n' | tee -a /etc/sudoers # passwordless sudo
  - mkdir build_chimaera
  - chown -R builduser:builduser ./
  - cd build_chimaera
  - cp ../PKGBUILD .
  - sudo -u builduser makedeb -s --no-confirm
  - ls -lah *.deb
  - mkdir /debs/chimaera_amd64
  - mv *.deb /debs/chimaera_amd64/
  - cd ..
  - exit 0

- name: build_amd64_beowulf
  image: dyne/devuan:beowulf
  pull: always
  commands:
  - su root
  - apt update
  - apt upgrade -y
  - apt install gpg -y
  - wget -qO - 'https://proget.makedeb.org/debian-feeds/makedeb.pub' | gpg --dearmor | tee /usr/share/keyrings/makedeb-archive-keyring.gpg 1> /dev/null
  - echo 'deb [signed-by=/usr/share/keyrings/makedeb-archive-keyring.gpg arch=all] https://proget.makedeb.org/ makedeb main' | tee /etc/apt/sources.list.d/makedeb.list
  - apt update
  - apt install makedeb -y
  - apt install sudo -y
  - useradd builduser -m
  - passwd -d builduser
  - printf 'builduser ALL=(ALL) ALL\n' | tee -a /etc/sudoers # passwordless sudo

  # Fix [E: Invalid operation satisfy] on beowulf
  # Devuan beowulf does not support [apt satisfy]. We need install makedepends manualy
  - apt install g++ make m4 build-essential -y

  - mkdir build_beowulf
  - chown -R builduser:builduser ./
  - cd build_beowulf
  - cp ../PKGBUILD .
  - sudo -u builduser makedeb -s --no-confirm
  - ls -lah *.deb
  - mkdir /debs/beowulf_amd64
  - mv *.deb /debs/beowulf_amd64/
  - cd ..
  - exit 0

- name: build_amd64_ceres
  image: dyne/devuan:ceres
  pull: always
  commands:
  - su root
  - apt update
  - apt install gpg -y
  - wget -qO - 'https://proget.makedeb.org/debian-feeds/makedeb.pub' | gpg --dearmor | tee /usr/share/keyrings/makedeb-archive-keyring.gpg 1> /dev/null
  - echo 'deb [signed-by=/usr/share/keyrings/makedeb-archive-keyring.gpg arch=all] https://proget.makedeb.org/ makedeb main' | tee /etc/apt/sources.list.d/makedeb.list
  - apt update
  - apt install makedeb -y
  - apt install sudo -y
  - useradd builduser -m
  - passwd -d builduser
  - printf 'builduser ALL=(ALL) ALL\n' | tee -a /etc/sudoers # passwordless sudo
  - apt install g++ make m4 build-essential -y
  - mkdir build_ceres
  - chown -R builduser:builduser ./
  - cd build_ceres
  - cp ../PKGBUILD .
  - sudo -u builduser makedeb -s --no-confirm
  - ls -lah *.deb
  - mkdir /debs/ceres_amd64
  - mv *.deb /debs/ceres_amd64/
  - cd ..
  - exit 0
